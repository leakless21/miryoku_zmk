/*
 * ZMK Keymap Configuration
 *
 * This file has been rewritten for clarity, formatting, and includes comments
 * to explain the various components of the configuration.
 */

#include <behaviors.dtsi>
#include <behaviors/mouse_keys.dtsi>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/rgb.h>
#include <dt-bindings/zmk/outputs.h>
#include <dt-bindings/zmk/ext_power.h>
#include <dt-bindings/zmk/pointing.h>

/ {
  keymap {
    compatible = "zmk,keymap";

    /* Base Layer: Default typing layer */
    BASE {
      display-name = "Base";
      bindings = <
        &none &none &none &none &none        &none &none &none &none &none
        &kp Q &kp W &kp F &kp P &kp B        &kp J &kp L &kp U &kp Y &kp SQT
        &u_mt LGUI A &u_mt LALT R &u_mt LCTRL S &u_mt LSHFT T &kp G        &kp M &u_mt LSHFT N &u_mt LCTRL E &u_mt LALT I &u_mt LGUI O
        &u_lt 3 Z &u_mt RALT X &kp C &kp D &kp V        &kp K &kp H &kp COMMA &u_mt RALT DOT &u_lt 3 SLASH
                          &u_lt 6 ESC &u_lt 4 SPACE &u_lt 5 TAB        &u_lt 8 RET &u_lt 7 BSPC &u_lt 9 DEL
      >;
    };

    /* Extra Layer */
    EXTRA {
      display-name = "Extra";
      bindings = <
        &none &none &none &none &none        &none &none &none &none &none
        &kp Q &kp W &kp E &kp R &kp T        &kp Y &kp U &kp I &kp O &kp P
        &u_mt LGUI A &u_mt LALT S &u_mt LCTRL D &u_mt LSHFT F &kp G        &kp H &u_mt LSHFT J &u_mt LCTRL K &u_mt LALT L &u_mt LGUI SQT
        &u_lt 3 Z &u_mt RALT X &kp C &kp V &kp B        &kp N &kp M &kp COMMA &u_mt RALT DOT &u_lt 3 SLASH
                          &u_lt 6 ESC &u_lt 4 SPACE &u_lt 5 TAB        &u_lt 8 RET &u_lt 7 BSPC &u_lt 9 DEL
      >;
    };

    /* Tap Layer: Keys without hold-tap behaviors */
    TAP {
      display-name = "Tap";
      bindings = <
        &none &none &none &none &none        &none &none &none &none &none
        &kp Q &kp W &kp F &kp P &kp B        &kp J &kp L &kp U &kp Y &kp SQT
        &kp A &kp R &kp S &kp T &kp G        &kp M &kp N &kp E &kp I &kp O
        &kp Z &kp X &kp C &kp D &kp V        &kp K &kp H &kp COMMA &kp DOT &kp SLASH
                          &kp ESC &kp SPACE &kp TAB        &kp RET &kp BSPC &kp DEL
      >;
    };

    /* Button Layer: Mouse buttons and editing keys */
    BUTTON {
      display-name = "Button";
      bindings = <
        &none &none &none &none &none        &none &none &none &none &none
        &kp K_UNDO &kp LS(DEL) &kp LC(INS) &kp LS(INS) &kp K_AGAIN        &kp K_AGAIN &kp LS(INS) &kp LC(INS) &kp LS(DEL) &kp K_UNDO
        &kp LGUI &kp LALT &kp LCTRL &kp LSHFT &none        &none &kp LSHFT &kp LCTRL &kp LALT &kp LGUI
        &kp K_UNDO &kp LS(DEL) &kp LC(INS) &kp LS(INS) &kp K_AGAIN        &kp K_AGAIN &kp LS(INS) &kp LC(INS) &kp LS(DEL) &kp K_UNDO
                          &mkp MB3 &mkp MB1 &mkp MB2        &mkp MB2 &mkp MB1 &mkp MB3
      >;
    };

    /* Nav Layer: Navigation and layer switching */
    NAV {
      display-name = "Nav";
      bindings = <
        &none &none &none &none &none        &none &none &none &none &none
        &bootloader &u_to_U_TAP &u_to_U_EXTRA &u_to_U_BASE &none        &kp K_AGAIN &kp LS(INS) &kp LC(INS) &kp LS(DEL) &kp K_UNDO
        &kp LGUI &kp LALT &kp LCTRL &kp LSHFT &none        &u_caps_word &kp LEFT &kp DOWN &kp UP &kp RIGHT
        &none &kp RALT &u_to_U_NUM &u_to_U_NAV &none        &kp INS &kp HOME &kp PG_DN &kp PG_UP &kp END
                                &none &none &none        &kp RET &kp BSPC &kp DEL
      >;
    };

    /* Mouse Layer: Mouse movement and scrolling */
    MOUSE {
      display-name = "Mouse";
      bindings = <
        &none &none &none &none &none        &none &none &none &none &none
        &bootloader &u_to_U_TAP &u_to_U_EXTRA &u_to_U_BASE &none        &kp K_AGAIN &kp LS(INS) &kp LC(ins) &kp LS(DEL) &kp K_UNDO
        &kp LGUI &kp LALT &kp LCTRL &kp LSHFT &none        &none &mmv MOVE_LEFT &mmv MOVE_DOWN &mmv MOVE_UP &mmv MOVE_RIGHT
        &none &kp RALT &u_to_U_SYM &u_to_U_MOUSE &none        &none &msc SCRL_LEFT &msc SCRL_DOWN &msc SCRL_UP &msc SCRL_RIGHT
                                &none &none &none        &mkp MB2 &mkp MB1 &mkp MB3
      >;
    };

    /* Media Layer: Media keys, RGB, and Bluetooth controls */
    MEDIA {
      display-name = "Media";
      bindings = <
        &none &none &none &none &none        &none &none &none &none &none
        &bootloader &u_to_U_TAP &u_to_U_EXTRA &u_to_U_BASE &none        &rgb_ug RGB_TOG &rgb_ug RGB_EFF &rgb_ug RGB_HUI &rgb_ug RGB_SAI &rgb_ug RGB_BRI
        &kp LGUI &kp LALT &kp LCTRL &kp LSHFT &none        &ext_power EP_TOG &kp C_PREV &kp C_VOL_DN &kp C_VOL_UP &kp C_NEXT
        &none &kp RALT &u_to_U_FUN &u_to_U_MEDIA &none        &u_out_tog &u_bt_sel_0 &u_bt_sel_1 &u_bt_sel_2 &u_bt_sel_3
                                &none &none &none        &kp C_STOP &kp C_PP &kp C_MUTE
      >;
    };

    /* Num Layer: Number pad */
    NUM {
      display-name = "Num";
      bindings = <
        &none &none &none &none &none        &none &none &none &none &none
        &kp LBKT &kp N7 &kp N8 &kp N9 &kp RBKT        &none &u_to_U_BASE &u_to_U_EXTRA &u_to_U_TAP &bootloader
        &kp SEMI &kp N4 &kp N5 &kp N6 &kp EQUAL        &none &kp LSHFT &kp LCTRL &kp LALT &kp LGUI
        &kp GRAVE &kp N1 &kp N2 &kp N3 &kp BSLH        &none &none &u_to_U_NUM &u_to_U_NAV &kp RALT
                                &kp DOT &kp N0 &kp MINUS        &none &none &none
      >;
    };

    /* Symbol Layer */
    SYM {
      display-name = "Sym";
      bindings = <
        &none &none &none &none &none        &none &none &none &none &none
        &kp LBRC &kp AMPS &kp ASTRK &kp LPAR &kp RBRC        &none &u_to_U_BASE &u_to_U_EXTRA &u_to_U_TAP &bootloader
        &kp COLON &kp DLLR &kp PRCNT &kp CARET &kp PLUS        &none &kp LSHFT &kp LCTRL &kp LALT &kp LGUI
        &kp TILDE &kp EXCL &kp AT &kp HASH &kp PIPE        &none &none &u_to_U_SYM &u_to_U_MOUSE &kp RALT
                                &kp LPAR &kp RPAR &kp UNDER        &none &none &none
      >;
    };

    /* Function Key Layer */
    FUN {
      display-name = "Fun";
      bindings = <
        &none &none &none &none &none        &none &none &none &none &none
        &kp F12 &kp F7 &kp F8 &kp F9 &kp PSCRN        &none &u_to_U_BASE &u_to_U_EXTRA &u_to_U_TAP &bootloader
        &kp F11 &kp F4 &kp F5 &kp F6 &kp SLCK        &none &kp LSHFT &kp LCTRL &kp LALT &kp LGUI
        &kp F10 &kp F1 &kp F2 &kp F3 &kp PAUSE_BREAK        &none &none &u_to_U_FUN &u_to_U_MEDIA &kp RALT
                                &kp K_APP &kp SPACE &kp TAB        &none &none &none
      >;
    };
  };

  // --- Custom Behaviors ---
  behaviors {
    // Hold-Tap: Modifier on Hold, Key on Tap
    u_mt: u_mt {
      compatible = "zmk,behavior-hold-tap";
      #binding-cells = <2>;
      tapping-term-ms = <200>;
      flavor = "tap-preferred"; // Prefers tap action in ambiguous cases
      bindings = <&kp>, <&kp>;
    };

    // Hold-Tap: Layer on Hold, Key on Tap
    u_lt: u_lt {
      compatible = "zmk,behavior-hold-tap";
      #binding-cells = <2>;
      tapping-term-ms = <200>;
      flavor = "tap-preferred";
      bindings = <&mo>, <&kp>;
    };

    // Mod-Morph for Bluetooth profile selection.
    // Default: Select profile. Shift + Key: Clear profile.
    u_bt_sel_0: u_bt_sel_0 { compatible = "zmk,behavior-mod-morph"; #binding-cells = <0>; bindings = <&bt BT_SEL 0>, <&u_macro_u_bt_sel_0>; mods = <(MOD_LSFT|MOD_RSFT)>; };
    u_bt_sel_1: u_bt_sel_1 { compatible = "zmk,behavior-mod-morph"; #binding-cells = <0>; bindings = <&bt BT_SEL 1>, <&u_macro_u_bt_sel_1>; mods = <(MOD_LSFT|MOD_RSFT)>; };
    u_bt_sel_2: u_bt_sel_2 { compatible = "zmk,behavior-mod-morph"; #binding-cells = <0>; bindings = <&bt BT_SEL 2>, <&u_macro_u_bt_sel_2>; mods = <(MOD_LSFT|MOD_RSFT)>; };
    u_bt_sel_3: u_bt_sel_3 { compatible = "zmk,behavior-mod-morph"; #binding-cells = <0>; bindings = <&bt BT_SEL 3>, <&u_macro_u_bt_sel_3>; mods = <(MOD_LSFT|MOD_RSFT)>; };
    u_bt_sel_4: u_bt_sel_4 { compatible = "zmk,behavior-mod-morph"; #binding-cells = <0>; bindings = <&bt BT_SEL 4>, <&u_macro_u_bt_sel_4>; mods = <(MOD_LSFT|MOD_RSFT)>; };

    // Mod-Morph for Output selection.
    // Default: Toggle output. Shift + Key: Switch to USB.
    u_out_tog: u_out_tog { compatible = "zmk,behavior-mod-morph"; #binding-cells = <0>; bindings = <&out OUT_TOG>, <&out OUT_USB>; mods = <(MOD_LSFT|MOD_RSFT)>; };

    // Mod-Morph for Caps Word.
    // Default: Caps Word. Shift + Key: Caps Lock.
    u_caps_word: u_caps_word { compatible = "zmk,behavior-mod-morph"; #binding-cells = <0>; bindings = <&caps_word>, <&kp CAPS>; mods = <(MOD_LSFT|MOD_RSFT)>; };

    // Tap-Dance for layer switching.
    // Requires a double tap to activate, preventing accidental layer changes.
    u_to_U_BASE:  u_to_U_BASE  { compatible = "zmk,behavior-tap-dance"; #binding-cells = <0>; tapping-term-ms = <200>; bindings = <&none>, <&to 0>; };
    u_to_U_EXTRA: u_to_U_EXTRA { compatible = "zmk,behavior-tap-dance"; #binding-cells = <0>; tapping-term-ms = <200>; bindings = <&none>, <&to 1>; };
    u_to_U_TAP:   u_to_U_TAP   { compatible = "zmk,behavior-tap-dance"; #binding-cells = <0>; tapping-term-ms = <200>; bindings = <&none>, <&to 2>; };
    u_to_U_NAV:   u_to_U_NAV   { compatible = "zmk,behavior-tap-dance"; #binding-cells = <0>; tapping-term-ms = <200>; bindings = <&none>, <&to 4>; };
    u_to_U_MOUSE: u_to_U_MOUSE { compatible = "zmk,behavior-tap-dance"; #binding-cells = <0>; tapping-term-ms = <200>; bindings = <&none>, <&to 5>; };
    u_to_U_MEDIA: u_to_U_MEDIA { compatible = "zmk,behavior-tap-dance"; #binding-cells = <0>; tapping-term-ms = <200>; bindings = <&none>, <&to 6>; };
    u_to_U_NUM:   u_to_U_NUM   { compatible = "zmk,behavior-tap-dance"; #binding-cells = <0>; tapping-term-ms = <200>; bindings = <&none>, <&to 7>; };
    u_to_U_SYM:   u_to_U_SYM   { compatible = "zmk,behavior-tap-dance"; #binding-cells = <0>; tapping-term-ms = <200>; bindings = <&none>, <&to 8>; };
    u_to_U_FUN:   u_to_U_FUN   { compatible = "zmk,behavior-tap-dance"; #binding-cells = <0>; tapping-term-ms = <200>; bindings = <&none>, <&to 9>; };
  };

  // --- Macros for Mod-Morph Behaviors ---
  macros {
    u_macro_u_bt_sel_0: u_macro_u_bt_sel_0 { compatible = "zmk,behavior-macro"; #binding-cells = <0>; wait-ms = <0>; bindings = <&bt BT_SEL 0 &bt BT_CLR>; };
    u_macro_u_bt_sel_1: u_macro_u_bt_sel_1 { compatible = "zmk,behavior-macro"; #binding-cells = <0>; wait-ms = <0>; bindings = <&bt BT_SEL 1 &bt BT_CLR>; };
    u_macro_u_bt_sel_2: u_macro_u_bt_sel_2 { compatible = "zmk,behavior-macro"; #binding-cells = <0>; wait-ms = <0>; bindings = <&bt BT_SEL 2 &bt BT_CLR>; };
    u_macro_u_bt_sel_3: u_macro_u_bt_sel_3 { compatible = "zmk,behavior-macro"; #binding-cells = <0>; wait-ms = <0>; bindings = <&bt BT_SEL 3 &bt BT_CLR>; };
    u_macro_u_bt_sel_4: u_macro_u_bt_sel_4 { compatible = "zmk,behavior-macro"; #binding-cells = <0>; wait-ms = <0>; bindings = <&bt BT_SEL 4 &bt BT_CLR>; };
  };
};

// --- Mouse Key Configuration ---
&mmv {
  acceleration-exponent = <1>;
  time-to-max-speed-ms = <1500>;
  delay-ms = <0>;
};
